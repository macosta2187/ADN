<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <title>Aplicación de Almacén</title>
    <style>
        .bg-custom-orange {
            background-color: #e16b16fb;
        }

        .table-hover tbody tr:hover {
            background-color: #e16b16fb;
          
        }
    </style>
</head>

<body>
    <header class="bg-custom-orange text-white">
        <div class="container">
            <h1 class="text-center">Aplicación de Almacén</h1>
        </div>
    </header>



    <div class="container text-center">
        <div class="row">
            <div class="col-md-4 mx-auto mb-3">
                <div class="form-group">
                    <label for="filtroDepartamento">Filtrar por Departamento:</label>
                    <select id="filtroDepartamento" class="form-control">
                        <option value="">Todos</option>
                        <option value="Artigas">Artigas</option>
                        <option value="Canelones">Canelones</option>
                        <option value="Cerro Largo">Cerro Largo</option>
                        <option value="Colonia">Colonia</option>
                        <option value="Durazno">Durazno</option>
                        <option value="Flores">Flores</option>
                        <option value="Florida">Florida</option>
                        <option value="Lavalleja">Lavalleja</option>
                        <option value="Maldonado">Maldonado</option>
                        <option value="Montevideo">Montevideo</option>
                        <option value="Paysandú">Paysandú</option>
                        <option value="Río Negro">Río Negro</option>
                        <option value="Rivera">Rivera</option>
                        <option value="Rocha">Rocha</option>
                        <option value="Salto">Salto</option>
                        <option value="San José">San José</option>
                        <option value="Soriano">Soriano</option>
                        <option value="Tacuarembó">Tacuarembó</option>
                        <option value="Treinta y Tres">Treinta y Tres</option>
                    </select>
                </div>
            </div>

            <div class="col-md-4 mx-auto mb-3">
                <div class="form-group">
                    <label for="filtroPeso">Filtrar por Peso:</label>
                    <select id="filtroPeso" class="form-control">
                        <option value="">Todos</option>
                        <option value="1000">Menos de 1000 kg</option>
                    </select>
                </div>
            </div>

            <div class="col-md-4 mx-auto mb-3">
                <div class="form-group">
                    <label for="inputLote" class="small">LOTE:</label>
                    <input type="text" id="inputLote" class="form-control" placeholder="Ingrese el número de lote" pattern="\d{1,3}" title="Ingresa un número de hasta 3 dígitos" required>
                </div>
            </div>          
              </div>
            <div class="col-md-4 mx-auto mb-3">
                <div class="form-group">
                    <label for="camionesSelect">Selecciona un camión:</label>
                    <select id="camionesSelect" class="form-control"></select>
                </div>
            </div>
        </div>
    </div>



    <table class="table table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Numero de Paquete</th>
                <th>Calle</th>
                <th>Número de puerta</th>
                <th>Localidad</th>
                <th>Departamento destino</th>
                <th>Estatus</th>
                <th>Tamaño del paquete</th>
                <th>Peso (kg)</th>
                <th>Teléfono contacto</th>
                <th>Fecha de recepción</th>
                <th>Seleccionar</th>
            </tr>
        </thead>
        <tbody id="paquetesData"></tbody>
    </table>


    <div class="alert alert-info" role="alert" id="sumaPesosLabel">Peso Total del envío en kg: 0.00 kg</div>
    <button onclick="consolidarPaquetes()" class="btn btn-warning mx-auto d-block">Consolidar Paquetes</button>



    <script>


        const camionesSelect = document.getElementById('camionesSelect');
        const filtroDepartamento = document.getElementById('filtroDepartamento');
        const filtroPeso = document.getElementById('filtroPeso');
        const paquetesData = document.getElementById('paquetesData');
        const sumaPesosLabel = document.getElementById('sumaPesosLabel');
        const consolidarButton = document.querySelector('button');

        let paquetes = [];

        listarCamiones();

        function listarCamiones() {
            fetch('http://127.0.0.1:8002/api/Camiones', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {

                    camionesSelect.innerHTML = '';
                    data.forEach(camion => {
                        const option = document.createElement('option');
                        option.value = camion.id_camion;
                        option.textContent = camion.id_camion;
                        camionesSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar los camiones:', error);
                });
        }

        function desmarcarCheckboxes() {
            const checkboxes = document.querySelectorAll('input[name="seleccionarPaquete"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
        }
        function cargarPaquetes() {
            fetch('http://127.0.0.1:8003/api/Paquete', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    paquetes = data;
                    actualizarTabla();
                })
                .catch(error => {
                    console.error('Error al cargar los datos:', error);
                });
        }

        function actualizarTabla() {
            const departamentoSeleccionado = filtroDepartamento.value;
            const pesoSeleccionado = parseFloat(filtroPeso.value);
            paquetesData.innerHTML = '';
            let sumaPesos = 0.0;

            paquetes.forEach(paquete => {
                if (
                    (!departamentoSeleccionado || paquete.departamento === departamentoSeleccionado) &&
                    (!pesoSeleccionado || parseFloat(paquete.peso) <= pesoSeleccionado)
                ) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${paquete.id}</td>
                        <td>${paquete.calle}</td>
                        <td>${paquete.numero}</td>
                        <td>${paquete.localidad}</td>
                        <td>${paquete.departamento}</td>
                        <td>${paquete.estatus}</td>
                        <td>${paquete.tamaño}</td>
                        <td>${paquete.peso}</td>
                        <td>${paquete.telefono}</td>
                        <td>${paquete.fecha}</td>
                        <td><input type="checkbox" name="seleccionarPaquete" value="${paquete.id}" data-peso="${paquete.peso}"></td>
                        

                    `;
                    paquetesData.appendChild(row);
                }
            });

            const checkboxes = document.querySelectorAll('input[name="seleccionarPaquete"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const pesoDelPaquete = parseFloat(this.getAttribute('data-peso'));

                    if (this.checked) {
                        sumaPesos += pesoDelPaquete;
                    } else {
                        sumaPesos -= pesoDelPaquete;
                    }
                    sumaPesosLabel.textContent = `Peso Total del envío en kg: ${sumaPesos.toFixed(2)} kg`;

                    if (sumaPesos >= 20) {
                        alert("El peso total es igual o mayor a 20 kg. Máxima capacidad de carga alcanzada");
                        sumaPesosLabel.textContent = `Peso Total del envío en kg: 0.00 kg`;
                        desmarcarCheckboxes();
                    }
                });
            });
        }

        filtroDepartamento.addEventListener('change', actualizarTabla);
        filtroPeso.addEventListener('change', actualizarTabla);
        cargarPaquetes();

        function consolidarPaquetes() {
            const checkboxes = document.querySelectorAll('input[name="seleccionarPaquete"]:checked');
            const loteValue = parseInt(document.getElementById('inputLote').value);
            const camionSeleccionado = parseInt(camionesSelect.value);

            if (isNaN(loteValue)) {
                alert("Ingresa un valor de lote válido.");
                return;
            }

            if (checkboxes.length === 0) {
                alert("Selecciona al menos un paquete para consolidar.");
                return;
            }

            const paquetesAConsolidar = Array.from(checkboxes).map(checkbox => {
                return {
                    paqueteId: parseInt(checkbox.value),
                    lote: loteValue,
                    estatus: "Consolidado",
                    camionId: camionSeleccionado
                };
            });

            const url = 'http://127.0.0.1:8003/api/PaqueteLote';
            sumaPesosLabel.textContent = `Peso Total del envío en kg: 0.00 kg`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ Paquetes: paquetesAConsolidar }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        cargarPaquetes();
                    } else {
                        alert('Error al consolidar paquetes.');
                    }
                })
                .catch(error => {
                    console.error('Error al consolidar paquetes:', error);
                });
        }

        $(document).ready(function () {
            var token = localStorage.getItem("accessToken");
            if (token == null)
                $(location).prop('href', '/ADN/Login_Almacen.html');

            $("#cerrarSesion").click(function () {
                jQuery.ajax({
                    url: 'http://127.0.0.1:8001/api/logout',
                    type: 'GET',
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem("accessToken"),
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                    },
                    success: function (data) {
                        localStorage.removeItem("accessToken");
                        $(location).prop('href', '/ADN/Login_Almacen.html');
                    }

                });
            });

        });

    </script>

</body>

</html>