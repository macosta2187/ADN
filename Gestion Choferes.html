<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="bootstrap/js/popper.min.js"></script>
    <script src="bootstrap/js/jquery-3.5.1.slim.min.js"></script>
    <title>Tabla de Lotes</title>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Aplicación Choferes</h1>
        <h2>Paquetes y lotes asignados al Camión</h2>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Número de Lote</th>
                    <th>Lote Asignado</th>
                    <th>Número de Paquete</th>
                    <th>Paquetes en Lote</th>
                    
                </tr>
            </thead>
            <tbody id="lotesData"></tbody>
        </table>
        <button id="cerrarSesion" class="btn btn-danger">Cerrar sesión</button>
    </div>
    <script>
        const lotesData = document.getElementById('lotesData');

        function cargarDatos() {
            fetch('http://127.0.0.1:8003/api/Lote', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    const groupedData = groupByLoteAndStatus(data);
                    renderTable(groupedData);
                })
                .catch(error => {
                    console.error('Error al cargar los datos:', error);
                });
        }

        function groupByLoteAndStatus(data) {
            const groupedData = {};

            data.forEach(lote => {
                const key = `${lote.lote}_${lote.estatus}`;
                if (!groupedData[key]) {
                    groupedData[key] = [];
                }
                groupedData[key].push(lote);
            });

            return groupedData;
        }

        function renderTable(groupedData) {
            lotesData.innerHTML = '';

            for (const key in groupedData) {
                if (groupedData.hasOwnProperty(key)) {
                    const rows = groupedData[key];
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${rows[0].id}</td>
                        <td>${rows[0].lote}</td>
                        <td>${rows[0].camionId}</td>
                        <td>${rows.map(lote => lote.paqueteId).join(', ')}</td>
                        <td>
                            <select onchange="cambiarEstatus(${rows[0].id}, this.value)">
                                <option value="Consolidado" ${rows[0].estatus === 'Consolidado' ? 'selected' : ''}>Consolidado</option>
                                <option value="En Transito" ${rows[0].estatus === 'En Transito' ? 'selected' : ''}>En Transito</option>
                                <option value="Desconsolidado" ${rows[0].estatus === 'Desconsolidado' ? 'selected' : ''}>Desconsolidado</option>
                            </select>
                        </td>
                    `;

                    lotesData.appendChild(row);
                }
            }
        }

        function cambiarEstatus(loteId, nuevoEstatus) {
            const url = `http://127.0.0.1:8003/api/Lote/${loteId}`;


            const data = {
                estatus: nuevoEstatus
            };
            const options = {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            };
            fetch(url, options)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error al actualizar el estatus: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(loteActualizado => {
                    console.log('Lote actualizado:', loteActualizado);
                    alert('Estatus actualizado con éxito.');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al actualizar el estatus.');
                });
        }


        cargarDatos();

        $(document).ready(function () {
            var token = localStorage.getItem("accessToken");
            if (token == null)
                $(location).prop('href', '/ADN/Login_Choferes.html');

            $("#cerrarSesion").click(function () {
                jQuery.ajax({
                    url: 'http://127.0.0.1:8001/api/logout',
                    type: 'GET',
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem("accessToken"),
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                    },
                    success: function (data) {
                        localStorage.removeItem("accessToken");
                        $(location).prop('href', '/ADN/Login_Choferes.html');
                    }

                });
            });

        });
    </script>
    <script src="js/jquery.min.js"></script>
</body>
</html>